<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>
            Chess
        </title>

        <!-- Favicon links (generated by favicon.io) -->
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="/assets/favicon/site.webmanifest">

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

        <!-- My personal CSS -->
        <link rel="stylesheet" href="/styles/fonts.css">
        <link rel="stylesheet" href="/styles/style.css">
        <!-- Add additional stylesheets here to override original styles as needed -->
        <link rel="stylesheet" href="/cm-chessboard/assets/chessboard.css">
        <link rel="stylesheet" href="/cm-chessboard/assets/extensions/markers/markers.css">
        <link rel="stylesheet" href="/cm-chessboard/assets/extensions/arrows/arrows.css">
        <link rel="stylesheet" href="/cm-chessboard/assets/extensions/promotion-dialog/promotion-dialog.css">
        <style>
            #board, #board2 {
                width: 400px;
                height: 400px;
                margin: auto;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.3);
            }
        </style>
    </head>
    <body>
        <div id="header"></div> <!-- Modify header content in header.html -->

        <div class="content">
            <h1>Chess</h1>
            <p> <!-- Add text here --> </p>
            <div id="board" class="my-5"></div>
            <div id="board2" class="my-5"></div>
        </div>

        <div id="footer"></div> <!-- Modify footer content in footer.html -->

        <!-- Bootstrap JS (includes Popper.js and Bootstrap JS) -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

        <!-- My personal JS -->
        <script src="/scripts/app.js" defer></script>
        <script src="/scripts/time.js"></script>
        <!-- Add additional JS here as needed -->
        <script type="module">
            import { Chessboard, FEN, INPUT_EVENT_TYPE, COLOR, BORDER_TYPE } from "/cm-chessboard/src/Chessboard.js"
            import { MARKER_TYPE, Markers } from "/cm-chessboard/src/extensions/markers/Markers.js"
            import { Arrows } from "/cm-chessboard/src/extensions/arrows/Arrows.js"
            import { RightClickAnnotator } from "/cm-chessboard/src/extensions/right-click-annotator/RightClickAnnotator.js"
            import { PROMOTION_DIALOG_RESULT_TYPE, PromotionDialog } from "/cm-chessboard/src/extensions/promotion-dialog/PromotionDialog.js"
            import { Chess } from "/cm-chessboard/src/Chess.js" // copied from https://cdn.jsdelivr.net/npm/chess.mjs@1/src/chess.mjs/Chess.js

            // Create first board
            const board = new Chessboard(document.getElementById("board"), {
                position: FEN.start,
                assetsUrl: "/cm-chessboard/assets/",
                extensions: [
                    { class: Markers }, // Looks better with markers. (Don't forget to also include the CSS for the markers)
                    { class: Arrows },
                    { class: RightClickAnnotator },
                    { class: PromotionDialog }
                ]
            });
            // Enable move input
            board.enableMoveInput(inputHandler);

            // Create second board
            const board2 = new Chessboard(document.getElementById("board2"), {
                assetsUrl: "/cm-chessboard/assets/",
                position: "rn2k1r1/ppp1pp1p/3p2p1/5bn1/P7/2N2B2/1PPPPP2/2BNK1RR w Gkq - 4 11",
                style: {
                    pieces: {
                        file: "pieces/staunty.svg"
                    },
                    cssClass: "green",
                    borderType: BORDER_TYPE.frame
                },
                orientation: COLOR.black,
                extensions: [
                    { class: Markers },
                    { class: Arrows },
                    { class: RightClickAnnotator }
                ]
            });
            board2.enableMoveInput(inputHandler);

            // function inputHandler(event) {
            //     console.log(event)
            //     if (
            //         event.type === INPUT_EVENT_TYPE.moveInputStarted || 
            //         event.type === INPUT_EVENT_TYPE.validateMoveInput
            //     ) {
            //         return true; // false cancels move
            //     }
            // }

            const chess = new Chess()

            let seed = 71;
            function random() {
                const x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            }
            function makeEngineMove(chessboard) {
                const possibleMoves = chess.moves({verbose: true})
                if (possibleMoves.length > 0) {
                    const randomIndex = Math.floor(random() * possibleMoves.length)
                    const randomMove = possibleMoves[randomIndex]
                    setTimeout(() => { // smoother with 500ms delay
                        chess.move({from: randomMove.from, to: randomMove.to})
                        chessboard.setPosition(chess.fen(), true)
                        chessboard.enableMoveInput(inputHandler, COLOR.white)
                    }, 500)
                }
                }


            function inputHandler(event) {
                console.log("inputHandler", event)
                if(event.type === INPUT_EVENT_TYPE.movingOverSquare) {
                    return // ignore this event
                }
                if(event.type !== INPUT_EVENT_TYPE.moveInputFinished) {
                    event.chessboard.removeLegalMovesMarkers()
                }
                if (event.type === INPUT_EVENT_TYPE.moveInputStarted) {
                    // mark legal moves
                    const moves = chess.moves({square: event.squareFrom, verbose: true})
                    event.chessboard.addLegalMovesMarkers(moves)
                    return moves.length > 0
                } else if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {
                    const move = {from: event.squareFrom, to: event.squareTo, promotion: event.promotion}
                    const result = chess.move(move)
                    if (result) {
                        event.chessboard.state.moveInputProcess.then(() => { // wait for the move input process has finished
                            event.chessboard.setPosition(chess.fen(), true).then(() => { // update position, maybe castled and wait for animation has finished
                                makeEngineMove(event.chessboard)
                            })
                        })
                    } else {
                        // promotion?
                        let possibleMoves = chess.moves({square: event.squareFrom, verbose: true})
                        for (const possibleMove of possibleMoves) {
                            if (possibleMove.promotion && possibleMove.to === event.squareTo) {
                                event.chessboard.showPromotionDialog(event.squareTo, COLOR.white, (result) => {
                                    console.log("promotion result", result)
                                    if (result.type === PROMOTION_DIALOG_RESULT_TYPE.pieceSelected) {
                                        chess.move({from: event.squareFrom, to: event.squareTo, promotion: result.piece.charAt(1)})
                                        event.chessboard.setPosition(chess.fen(), true)
                                        makeEngineMove(event.chessboard)
                                    } else {
                                        // promotion canceled
                                        event.chessboard.enableMoveInput(inputHandler, COLOR.white)
                                        event.chessboard.setPosition(chess.fen(), true)
                                    }
                                })
                                return true
                            }
                        }
                    }
                    return result
                } else if (event.type === INPUT_EVENT_TYPE.moveInputFinished) {
                    if(event.legalMove) {
                        event.chessboard.disableMoveInput()
                    }
                }
            }

        </script>
    </body>
</html>