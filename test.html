<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
</head>
<body>
    <h2>Chess Game</h2>
    <div id="board" style="width: 400px"></div>
    <button onclick="startGame()">New Game</button>
    <button onclick="undoMove()">Undo Move</button>
    <button onclick="exportPGN()">Export PGN</button>
    <input type="file" id="pgnInput" onchange="importPGN(event)">
    <select id="difficulty">
        <option value="1">Easy</option>
        <option value="5">Medium</option>
        <option value="10">Hard</option>
    </select>
    <button onclick="playStockfish()">Play vs Stockfish</button>
    <p id="stockfishEval"></p>
    
    <script>
        let board;
        let game = new Chess();
        let stockfish = new Worker("https://stockfish.online/stockfish.js");
        
        function onDragStart(source, piece, position, orientation) {
            if (game.game_over()) return false;
        }
        
        function onDrop(source, target) {
            let move = game.move({ from: source, to: target, promotion: "q" });
            if (!move) return 'snapback';
            board.position(game.fen());
            evaluatePosition();
        }
        
        function startGame() {
            game.reset();
            board.position('start');
        }
        
        function undoMove() {
            game.undo();
            board.position(game.fen());
        }
        
        function exportPGN() {
            alert(game.pgn());
        }
        
        function importPGN(event) {
            let file = event.target.files[0];
            let reader = new FileReader();
            reader.onload = function(e) {
                game.load_pgn(e.target.result);
                board.position(game.fen());
            };
            reader.readAsText(file);
        }
        
        function playStockfish() {
            let difficulty = document.getElementById("difficulty").value;
            stockfish.postMessage("uci");
            stockfish.postMessage("setoption name Skill Level value " + difficulty);
            stockfish.postMessage("position fen " + game.fen());
            stockfish.postMessage("go depth 15");
        }
        
        stockfish.onmessage = function(event) {
            if (event.data.includes("bestmove")) {
                let match = event.data.match(/bestmove\s(\S+)/);
                if (match) {
                    game.move(match[1], { sloppy: true });
                    board.position(game.fen());
                }
            } else if (event.data.includes("Total evaluation")) {
                document.getElementById("stockfishEval").innerText = "Stockfish Eval: " + event.data;
            }
        };
        
        document.addEventListener("DOMContentLoaded", function() {
            board = Chessboard("board", { 
                draggable: true, 
                position: "start", 
                onDragStart: onDragStart, 
                onDrop: onDrop 
            });
        });
    </script>
</body>
</html>
