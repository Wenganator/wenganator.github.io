<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gale‚ÄìShapley Stable Matching Visualizer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .entity-box { background: white; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .entity-header { font-weight: bold; text-align: center; }
    .list-group-item { cursor: grab; }
    #visualization { min-height: 400px; border: 2px dashed #ccc; border-radius: 10px; position: relative; overflow: hidden; }
    .applicant, .program {
      position: absolute; padding: 0.5rem 1rem; border-radius: 6px; color: white;
      transition: all 0.8s ease;
    }
    .applicant { background: #0d6efd; }
    .program { background: #20c997; }
    #log { height: 200px; overflow-y: auto; background: #000; color: #0f0; font-family: monospace; padding: 0.5rem; border-radius: 8px; }
  </style>
</head>
<body class="container py-4">
  <h1 class="text-center mb-4">Gale‚ÄìShapley Stable Matching Visualizer</h1>

  <div class="row">
    <div class="col-md-4">
      <div id="applicants" class="entity-box">
        <div class="entity-header">Applicants</div>
        <div id="applicantList"></div>
        <button id="addApplicant" class="btn btn-sm btn-outline-primary mt-2 w-100">+ Add Applicant</button>
      </div>
    </div>

    <div class="col-md-4">
      <div id="programs" class="entity-box">
        <div class="entity-header">Programs</div>
        <div id="programList"></div>
        <button id="addProgram" class="btn btn-sm btn-outline-primary mt-2 w-100">+ Add Program</button>
      </div>
    </div>

    <div class="col-md-4">
      <div id="controls" class="entity-box">
        <div class="entity-header">Controls</div>
        <div class="d-grid gap-2">
          <button id="play" class="btn btn-success">‚ñ∂ Play</button>
          <button id="step" class="btn btn-secondary">‚è© Step</button>
          <button id="pause" class="btn btn-warning">‚è∏ Pause</button>
          <button id="reset" class="btn btn-danger">üîÑ Reset</button>
          <button id="randomize" class="btn btn-info">üé≤ Randomize Preferences</button>
        </div>
      </div>
    </div>
  </div>

  <h4>Visualization</h4>
  <div id="visualization"></div>

  <h4 class="mt-4">Log</h4>
  <div id="log"></div>

  <script>
    // ---- Data Structures ----
    let applicants = [];
    let programs = [];
    let matches = {};
    let running = false, stepMode = false, stepIndex = 0, logEl = document.getElementById('log');

    // ---- Helper Functions ----
    const log = msg => {
      logEl.innerHTML += msg + "<br>";
      logEl.scrollTop = logEl.scrollHeight;
    };

    const createEntity = (name, listId, onRename) => {
      const div = document.createElement('div');
      div.classList.add('mb-3');
      div.innerHTML = `
        <input type="text" class="form-control mb-2 entity-name" value="${name}">
        <ul class="list-group sortable"></ul>
      `;
      document.getElementById(listId).appendChild(div);
      div.querySelector('.entity-name').addEventListener('input', e => onRename(e.target.value));
      return div;
    };

    const createSortable = (ul, items) => {
      ul.innerHTML = "";
      items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = item;
        ul.appendChild(li);
      });
      Sortable.create(ul, { animation: 150 });
    };

    const initDefaults = () => {
      applicants = ["A1", "A2", "A3"];
      programs = ["P1", "P2", "P3"];
      renderEntities();
    };

    const renderEntities = () => {
      document.getElementById('applicantList').innerHTML = "";
      document.getElementById('programList').innerHTML = "";
      applicants.forEach(a => {
        const div = createEntity(a, "applicantList", newName => {
          applicants[applicants.indexOf(a)] = newName;
        });
        createSortable(div.querySelector('.sortable'), [...programs]);
      });
      programs.forEach(p => {
        const div = createEntity(p, "programList", newName => {
          programs[programs.indexOf(p)] = newName;
        });
        createSortable(div.querySelector('.sortable'), [...applicants]);
      });
    };

    const getPreferences = () => {
      const applicantPrefs = {};
      document.querySelectorAll('#applicantList .mb-3').forEach((div, i) => {
        applicantPrefs[applicants[i]] = [...div.querySelectorAll('.list-group-item')].map(li => li.textContent);
      });
      const programPrefs = {};
      document.querySelectorAll('#programList .mb-3').forEach((div, i) => {
        programPrefs[programs[i]] = [...div.querySelectorAll('.list-group-item')].map(li => li.textContent);
      });
      return { applicantPrefs, programPrefs };
    };

    const randomizePrefs = () => {
      const shuffle = arr => arr.sort(() => Math.random() - 0.5);
      document.querySelectorAll('#applicantList .sortable').forEach(ul => createSortable(ul, shuffle([...programs])));
      document.querySelectorAll('#programList .sortable').forEach(ul => createSortable(ul, shuffle([...applicants])));
      log("Preferences randomized.");
    };

    const drawVisualization = () => {
      const vis = document.getElementById('visualization');
      vis.innerHTML = "";
      applicants.forEach((a, i) => {
        const el = document.createElement('div');
        el.className = 'applicant';
        el.textContent = a;
        el.style.left = "10%";
        el.style.top = `${(i + 1) * 80}px`;
        vis.appendChild(el);
      });
      programs.forEach((p, i) => {
        const el = document.createElement('div');
        el.className = 'program';
        el.textContent = p;
        el.style.right = "10%";
        el.style.top = `${(i + 1) * 80}px`;
        vis.appendChild(el);
      });
    };

    const animateProposal = async (a, p) => {
      const vis = document.getElementById('visualization');
      const applicantEl = [...vis.querySelectorAll('.applicant')].find(el => el.textContent === a);
      const programEl = [...vis.querySelectorAll('.program')].find(el => el.textContent === p);
      if (!applicantEl || !programEl) return;
      const origLeft = applicantEl.style.left;
      applicantEl.style.left = "45%";
      applicantEl.style.top = programEl.style.top;
      await new Promise(res => setTimeout(res, 1000));
      applicantEl.style.left = origLeft;
      applicantEl.style.top = programEl.style.top;
    };

    // ---- Gale‚ÄìShapley Algorithm ----
    const galeShapley = async (applicantPrefs, programPrefs) => {
      matches = {};
      const free = [...applicants];
      const proposals = {};
      applicants.forEach(a => proposals[a] = []);
      while (free.length && running) {
        const a = free[0];
        const prefs = applicantPrefs[a];
        const p = prefs.find(choice => !proposals[a].includes(choice));
        proposals[a].push(p);
        await animateProposal(a, p);
        log(`${a} proposes to ${p}`);
        const current = matches[p];
        if (!current) {
          matches[p] = a;
          free.shift();
          log(`${p} accepts ${a}`);
        } else {
          const pref = programPrefs[p];
          if (pref.indexOf(a) < pref.indexOf(current)) {
            matches[p] = a;
            free.shift();
            free.push(current);
            log(`${p} prefers ${a} over ${current}; ${current} becomes free`);
          } else {
            log(`${p} rejects ${a} (prefers ${current})`);
          }
        }
        await new Promise(res => setTimeout(res, 1000));
      }
      log("<strong>Final matches:</strong>");
      Object.entries(matches).forEach(([p, a]) => log(`${p} ‚Üî ${a}`));
    };

    // ---- Event Listeners ----
    document.getElementById('play').onclick = async () => {
      running = true;
      logEl.innerHTML = "";
      const { applicantPrefs, programPrefs } = getPreferences();
      drawVisualization();
      galeShapley(applicantPrefs, programPrefs);
    };

    document.getElementById('pause').onclick = () => running = false;
    document.getElementById('reset').onclick = () => { logEl.innerHTML = ""; drawVisualization(); };
    document.getElementById('randomize').onclick = randomizePrefs;
    document.getElementById('addApplicant').onclick = () => { applicants.push(`A${applicants.length + 1}`); renderEntities(); };
    document.getElementById('addProgram').onclick = () => { programs.push(`P${programs.length + 1}`); renderEntities(); };

    // ---- Init ----
    initDefaults();
    drawVisualization();
  </script>
</body>
</html>
